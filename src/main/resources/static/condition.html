<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Condition 생성</title>

  <!-- SDK 동적 삽입 -->
  <script>
    const queryParams = new URLSearchParams(location.search);
    const projectKey = queryParams.get('projectKey');

    if (!projectKey) {
      alert("projectKey가 전달되지 않았습니다.");
    }

    const sdk = document.createElement('script');
    sdk.src = "https://behavior-tracking-sdk.vercel.app/sdk.js";
    sdk.dataset.key = projectKey;

    if (location.hostname.includes('localhost')) {
      sdk.dataset.api = 'http://localhost:8080';
    }

    document.head.appendChild(sdk);
  </script>
</head>
<body>
<h1>조건 생성</h1>

<label>EventType:
  <select id="eventType">
    <option value="PAGE_VIEW">PAGE_VIEW</option>
    <option value="CLICK">CLICK</option>
    <option value="STAY_TIME">STAY_TIME</option>
    <option value="SCROLL_DEPTH">SCROLL_DEPTH</option>
  </select>
</label><br>

<label>Operator:
  <select id="operator">
    <option value="GREATER_THAN">GREATER_THAN</option>
    <option value="EQUAL">EQUAL</option>
    <option value="LESS_THAN">LESS_THAN</option>
  </select>
</label><br>

<label>Threshold:
  <input type="number" id="threshold" value="5" />
</label><br>

<label>Page URL:
  <input type="text" id="pageUrl" value="" />
</label><br><br>

<button id="btnCreate">생성</button>

<script>
  // 현재 페이지 URL에서 쿼리스트링 제거한 기본값 설정
  document.getElementById('pageUrl').value =
    location.origin + location.pathname.replace('condition.html', 'verify.html');

  document.getElementById('btnCreate').addEventListener('click', async () => {
    const sdkScript = document.querySelector('script[src*="sdk.js"]');
    const projectId = sdkScript?.dataset.key;
    const apiUrl = sdkScript?.dataset.api || (
      location.hostname.includes('localhost')
        ? 'http://localhost:8080'
        : 'https://sdk-behavior-trigger-mvp.onrender.com'
    );

    const pageUrlValue = document.getElementById('pageUrl').value;

    const payload = {
      projectId,
      eventType: document.getElementById('eventType').value,
      operator: document.getElementById('operator').value,
      threshold: parseInt(document.getElementById('threshold').value, 10),
      pageUrl: pageUrlValue
    };

    try {
      const res = await fetch(`${apiUrl}/api/conditions`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': 'Bearer ' + localStorage.getItem('token')
        },
        body: JSON.stringify(payload)
      });

      if (res.ok) {
        alert('조건이 성공적으로 생성되었습니다!');

        // ✅ 사용자가 작성한 pageUrl에 projectKey 추가 후 이동
        const redirectUrl = new URL(pageUrlValue);
        redirectUrl.searchParams.set('projectKey', projectId);
        window.location.href = redirectUrl.toString();

      } else {
        const text = await res.text();
        alert(`조건 생성 실패: ${res.status}\n${text}`);
      }
    } catch (err) {
      console.error(err);
      alert('조건 생성 중 오류 발생');
    }
  });
</script>
</body>
</html>
