<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>ë¡œê·¸ í™•ì¸</title>
  <style>
    body { font-family: sans-serif; padding: 2rem; }
    select, button { padding: 0.5rem; font-size: 1rem; margin-right: 1rem; }
    .log-entry { border: 1px solid #ccc; padding: 1rem; margin-bottom: 1rem; border-radius: 6px; }
  </style>
</head>
<body>

<h1>ğŸ“œ ë¡œê·¸ ëª©ë¡</h1>

<div>
  <label>ë„ë©”ì¸:
    <select id="domainSelect">
      <option value="">-- ì„ íƒ --</option>
    </select>
  </label>

  <label>ì¡°ê±´:
    <select id="conditionSelect">
      <option value="">-- ì„ íƒ --</option>
    </select>
  </label>

  <button id="filterBtn">í•„í„° ì ìš©</button>
  <button id="resetBtn">ì „ì²´ ë¡œê·¸ ë³´ê¸°</button>
  <button onclick="location.href='/me.html'">â† ë’¤ë¡œê°€ê¸°</button>
</div>

<hr>

<div id="logList">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>

<script>
  const params = new URLSearchParams(location.search);
  const projectKey = params.get('projectKey');
  const domainSelect = document.getElementById('domainSelect');
  const conditionSelect = document.getElementById('conditionSelect');
  const logList = document.getElementById('logList');
  const token = localStorage.getItem('token');

  if (!projectKey) {
    alert('projectKeyê°€ ì—†ìŠµë‹ˆë‹¤.');
    location.href = '/me.html';
  }

  let conditions = [];
  let logs = [];

  async function loadData() {
    const headers = {
      'Authorization': 'Bearer ' + token,
      'X-Domain': location.origin + location.pathname
    };

    // í”„ë¡œì íŠ¸ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
    const projRes = await fetch(`/api/projects/${projectKey}`, { headers });
    const project = await projRes.json();
    project.allowedDomains.forEach(domain => {
      const opt = document.createElement('option');
      opt.value = domain;
      opt.textContent = domain;
      domainSelect.appendChild(opt);
    });

    // ì¡°ê±´ ëª©ë¡ ê°€ì ¸ì˜¤ê¸°
    const condRes = await fetch(`/api/conditions/${projectKey}`, { headers });
    conditions = await condRes.json();
    conditions.forEach(cond => {
      const opt = document.createElement('option');
      opt.value = cond.id;
      opt.textContent = `[${cond.eventType}] ${cond.pageUrl}`;
      conditionSelect.appendChild(opt);
    });

    // âœ… ë¡œê·¸ ëª©ë¡ ê°€ì ¸ì˜¤ê¸° (í—¤ë”ì— X-Domain í¬í•¨)
    const logRes = await fetch(`/api/logs?projectId=${projectKey}`, { headers });
    logs = await logRes.json();
    renderLogs();
  }

  function renderLogs() {
    const selectedDomain = domainSelect.value;
    const selectedCondition = conditionSelect.value;

    const filtered = logs.filter(log => {
      const matchDomain = selectedDomain ? log.pageUrl.includes(selectedDomain) : true;
      const matchCond = selectedCondition ? log.conditionId === selectedCondition : true;
      return matchDomain && matchCond;
    });

    if (filtered.length === 0) {
      logList.innerHTML = '<p>í•´ë‹¹ ì¡°ê±´ì— ë§ëŠ” ë¡œê·¸ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
      return;
    }

    logList.innerHTML = '';
    filtered.forEach(log => {
      const div = document.createElement('div');
      div.className = 'log-entry';
      div.innerHTML = `
        <div><strong>ì´ë²¤íŠ¸:</strong> ${log.eventType}</div>
        <div><strong>ë°œìƒ ì‹œê°:</strong> ${log.occurredAt}</div>
        <div><strong>í˜ì´ì§€ URL:</strong> ${log.pageUrl}</div>
        <div><strong>ë°©ë¬¸ì ID:</strong> ${log.visitorId}</div>
        <div><strong>ì¡°ê±´ ID:</strong> ${log.conditionId || '(ì—†ìŒ)'}</div>
        <button onclick="deleteLog('${log.id}')">ğŸ—‘ ì‚­ì œ</button>
      `;
      logList.appendChild(div);
    });
  }

  async function deleteLog(logId) {
    const headers = {
      'Authorization': 'Bearer ' + token,
      'X-Domain': location.origin + location.pathname
    };

    if (!confirm('ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
    const res = await fetch(`/api/logs/${logId}`, {
      method: 'DELETE',
      headers
    });
    if (res.ok) {
      alert('ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
      logs = logs.filter(l => l.id !== logId);
      renderLogs();
    } else {
      alert('ì‚­ì œ ì‹¤íŒ¨');
    }
  }

  document.getElementById('filterBtn').addEventListener('click', renderLogs);

  loadData();

  // ì „ì²´ ë¡œê·¸ ë‹¤ì‹œ ë¶ˆëŸ¬ì˜¤ê¸°
document.getElementById('resetBtn').addEventListener('click', async () => {
  const res = await fetch(`/api/logs?projectId=${projectKey}`, {
    headers: { 'Authorization': 'Bearer ' + token }
  });
  logs = await res.json();
  domainSelect.value = '';
  conditionSelect.value = '';
  renderLogs();
});

</script>
</body>
</html>
